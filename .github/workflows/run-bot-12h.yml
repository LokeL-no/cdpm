name: ðŸ¤– Polymarket Bot (12 timer)

on:
  workflow_dispatch:  # Manuell trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 timer maks

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Installer avhengigheter
        run: pip install -r requirements.txt

      - name: ðŸŒ Installer cloudflared (tunnel)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: ðŸš€ Start bot og tunnel
        run: |
          # Start botten i bakgrunnen (web_bot.py med auto-discovery)
          python3 web_bot.py &
          BOT_PID=$!
          
          # Vent litt sÃ¥ botten starter
          sleep 5
          
          # Start Cloudflare tunnel (gratis, ingen konto nÃ¸dvendig)
          ./cloudflared tunnel --url http://localhost:8080 2>&1 | tee tunnel.log &
          TUNNEL_PID=$!
          
          # Vent pÃ¥ at tunnel-URL vises
          sleep 10
          
          # Finn og vis URL
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ BOT KJÃ˜RER MED AUTO-DISCOVERY!"
          echo "=============================================="
          TUNNEL_URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' tunnel.log | head -1)
          echo "ðŸ“± Ã…pne pÃ¥ telefonen: $TUNNEL_URL"
          echo "ðŸ” Auto-discovery: BTC 15m markets"
          echo "â° Varighet: 12 timer"
          echo "=============================================="
          echo ""
          
          # Hold workflow kjÃ¸rende i 12 timer
          echo "â° Bot kjÃ¸rer i 12 timer (eller til du stopper den)"
          echo "ðŸ›‘ Stopp: GÃ¥ til Actions â†’ klikk pÃ¥ workflow â†’ Cancel"
          
          # Vis status hvert 5. minutt (144 iterasjoner = 12 timer)
          for i in $(seq 1 144); do
            sleep 300
            HOURS=$((i*5/60))
            MINS=$((i*5%60))
            echo "â° $(date '+%H:%M') - Bot har kjÃ¸rt i ${HOURS}t ${MINS}m"
          done
          
          # Cleanup
          kill $BOT_PID $TUNNEL_PID 2>/dev/null || true
