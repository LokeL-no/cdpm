name: ðŸ¤– Polymarket Bot (6 timer)

on:
  workflow_dispatch:  # Manuell trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 timer

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Installer avhengigheter
        run: pip install -r requirements.txt

      - name: ðŸŒ Installer cloudflared (tunnel)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: ðŸš€ Start bot og tunnel
        run: |
          set -euo pipefail

          python3 web_bot.py &
          BOT_PID=$!

          sleep 5

          ./cloudflared tunnel --url http://localhost:8080 2>&1 | tee tunnel.log &
          TUNNEL_PID=$!

          sleep 10

          TUNNEL_URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' tunnel.log | head -1 || true)

          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ BOT KJÃ˜RER I 6 TIMER"
          if [ -n "$TUNNEL_URL" ]; then
            echo "ðŸ“± Ã…pne dashboardet pÃ¥ telefonen: $TUNNEL_URL"
          else
            echo "âš ï¸ Fant ikke tunnel-URL automatisk, sjekk 'tunnel.log' for detaljer"
          fi
          echo "ðŸ” Auto-discovery aktiv, fÃ¸lg PNL i sanntid"
          echo "=============================================="
          echo ""

          trap 'echo "\nðŸ›‘ Stopper bot og tunnel"; kill $BOT_PID $TUNNEL_PID 2>/dev/null || true; exit 0' INT TERM

          echo "â° Botten kjÃ¸rer i 6 timer (360 minutter)."
          echo "ðŸ›‘ For Ã¥ avbryte: Actions â†’ Velg workflow â†’ Cancel run."

          for i in $(seq 1 72); do
            sleep 300
            ELAPSED_MIN=$((i * 5))
            HOURS=$((ELAPSED_MIN / 60))
            MINS=$((ELAPSED_MIN % 60))
            printf 'â±ï¸ %s - Bot har kjÃ¸rt i %02dt %02dm\n' "$(date '+%H:%M:%S')" "$HOURS" "$MINS"
          done

          echo "âœ… 6 timer fullfÃ¸rt, rydder opp..."
          kill $BOT_PID $TUNNEL_PID 2>/dev/null || true
