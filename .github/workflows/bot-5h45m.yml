name: ğŸ¤– Polymarket Bot (5t 45m)

on:
  workflow_dispatch:  # Manuell trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 345  # 5 timer 45 min

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Installer avhengigheter
        run: pip install -r requirements.txt

      - name: ğŸŒ Installer cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      - name: ğŸš€ Start bot og tunnel
        run: |
          # Start bot
          nohup python3 web_bot.py > bot.log 2>&1 &
          BOT_PID=$!
          echo "âœ… Bot startet (PID: $BOT_PID)"
          sleep 5
          
          # Sjekk at bot kjÃ¸rer
          if ! ps -p $BOT_PID > /dev/null; then
            echo "âŒ Bot feilet!"
            cat bot.log
            exit 1
          fi
          echo "âœ… Bot kjÃ¸rer pÃ¥ localhost:8080"
          
          # Start tunnel med stderr redirect
          nohup cloudflared tunnel --url http://localhost:8080 2>&1 | tee tunnel.log &
          TUNNEL_PID=$!
          
          # Vent pÃ¥ URL (cloudflared skriver til stderr)
          echo "â³ Venter pÃ¥ tunnel-URL..."
          TUNNEL_URL=""
          for i in {1..60}; do
            sleep 1
            TUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log 2>/dev/null | head -1 || true)
            if [ -n "$TUNNEL_URL" ]; then
              break
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ GABAGOOL V6 - POLYMARKET BOT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -n "$TUNNEL_URL" ]; then
            echo ""
            echo "ğŸ“± Ã…PNE DENNE URLEN PÃ… TELEFONEN:"
            echo ""
            echo "   $TUNNEL_URL"
            echo ""
          else
            echo ""
            echo "âš ï¸  Tunnel-URL ikke funnet automatisk"
            echo "ğŸ“‹ Sjekk loggen under for URL:"
            echo ""
            cat tunnel.log | head -50
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â° KjÃ¸rer i 5 timer 45 minutter"
          echo "ğŸ›‘ Stopp: Actions â†’ Cancel workflow run"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # KjÃ¸r i 5t 45m (69 x 5 min = 345 min)
          for i in $(seq 1 69); do
            sleep 300
            ELAPSED=$((i * 5))
            H=$((ELAPSED / 60))
            M=$((ELAPSED % 60))
            echo "â±ï¸ $(date '+%H:%M') - KjÃ¸rt ${H}t ${M}m"
          done
          
          echo "âœ… Ferdig!"
