name: ðŸ¤– Polymarket Bot (5.5 timer)

on:
  workflow_dispatch:  # Manuell trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 330  # 5 timer 30 min

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Installer avhengigheter
        run: pip install -r requirements.txt

      - name: ðŸŒ Installer cloudflared (tunnel)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          ./cloudflared --version

      - name: ðŸš€ Start bot og tunnel
        run: |
          set -euo pipefail

          # Start bot i bakgrunnen
          python3 web_bot.py &
          BOT_PID=$!
          echo "Bot startet med PID: $BOT_PID"

          # Vent til botten er klar
          sleep 8

          # Start cloudflared tunnel
          ./cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo "Tunnel startet med PID: $TUNNEL_PID"

          # Vent pÃ¥ at tunnelen etableres
          echo "Venter pÃ¥ tunnel-URL..."
          for i in $(seq 1 30); do
            sleep 2
            if grep -q "trycloudflare.com" tunnel.log 2>/dev/null; then
              break
            fi
            echo "  Venter... ($i/30)"
          done

          # Hent tunnel-URL med flere mÃ¸nstre
          TUNNEL_URL=""
          TUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log 2>/dev/null | head -1 || true)
          
          if [ -z "$TUNNEL_URL" ]; then
            TUNNEL_URL=$(grep -o 'https://[^[:space:]]*trycloudflare.com[^[:space:]]*' tunnel.log 2>/dev/null | head -1 || true)
          fi

          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ GABAGOOL V6 BOT KJÃ˜RER I 5.5 TIMER"
          echo "=============================================="
          if [ -n "$TUNNEL_URL" ]; then
            echo "ðŸ“± DASHBOARD URL: $TUNNEL_URL"
            echo ""
            echo "ðŸ‘† Kopier denne URLen og Ã¥pne i nettleseren!"
          else
            echo "âš ï¸ Kunne ikke finne tunnel-URL automatisk"
            echo "ðŸ“‹ Tunnel log innhold:"
            cat tunnel.log || echo "(tom)"
          fi
          echo "=============================================="
          echo "ðŸ” Auto-discovery aktiv, fÃ¸lg PNL i sanntid"
          echo "â° Botten kjÃ¸rer i 5t 30min (330 minutter)"
          echo "ðŸ›‘ For Ã¥ avbryte: Actions â†’ Cancel run"
          echo "=============================================="
          echo ""

          trap 'echo "ðŸ›‘ Stopper bot og tunnel"; kill $BOT_PID $TUNNEL_PID 2>/dev/null || true; exit 0' INT TERM

          # KjÃ¸r i 5.5 timer (66 x 5 min)
          for i in $(seq 1 66); do
            sleep 300
            ELAPSED_MIN=$((i * 5))
            HOURS=$((ELAPSED_MIN / 60))
            MINS=$((ELAPSED_MIN % 60))
            printf 'â±ï¸ %s - Bot har kjÃ¸rt i %dh %02dm\n' "$(date '+%H:%M:%S')" "$HOURS" "$MINS"
          done

          echo "âœ… 5.5 timer fullfÃ¸rt!"
          kill $BOT_PID $TUNNEL_PID 2>/dev/null || true
